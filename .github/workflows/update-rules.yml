name: update rules

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 设置Python 3.10 并启用缓存
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      # 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 运行rule_merger.py
      - name: Run rule merger
        run: |
          cd src/python
          python rule_merger.py

      # 确保output目录存在并移动文件
      - name: Move generated rules
        run: |
          # 确保目标目录存在
          mkdir -p output
          
          cd src/python
          # 确保目标目录存在并为空
          rm -rf ../../output/*
          # 移动文件
          mv output/* ../../output/

      # 获取当前时间
      - name: Get current time
        id: time
        run: echo "time=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      # 切换到release分支并提交规则文件
      - name: Switch to release branch
        run: |
          git fetch origin release || true
          git checkout release || git checkout -b release
          cp -r output/* .
          rm -rf output

      # 提交规则文件到release分支
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 🚀 Update at ${{ steps.time.outputs.TIME }}
          branch: release
          skip_dirty_check: true
          push_options: '--force'
          create_branch: true
          skip_fetch: true
          skip_checkout: true
          commit_options: '--allow-empty'
          file_pattern: '*.yaml'

      # 切回main分支并清理生成的规则
      - name: Clean up main branch
        run: |
          git checkout main
          rm -rf output

      # 删除旧的workflow runs
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 3